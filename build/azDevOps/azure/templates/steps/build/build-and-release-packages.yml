parameters:
  pool:
    vmImage: "ubuntu-latest"
  root_src_dir: ""
  repo_name: stacks-dotnet-cqrs
  dotnet_core_version: "3.1.x"

steps:

  - task: UseDotNet@2
    displayName: 'Use .NET Core SDK ${{ parameters.dotnet_core_version }}'
    inputs:
      packageType: sdk
      version: ${{ parameters.dotnet_core_version }}
      installationPath: $(Agent.ToolsDirectory)/dotnet

  # Build Nuget packages for templates
  - task: Bash@3
    displayName: Create Packages
    inputs:
      targetType: "inline"
      workingDirectory: ${{ parameters.root_src_dir }}
      script: |
        ls -l
        cp $REPO_NAME/template.csproj .
        mkdir ./templates
        pushd templates
        cp -r ${ROOT_SRC_DIR}/$REPO_NAME .
        cp -r ${ROOT_SRC_DIR}/$REPO_NAME/src/api .
        popd

        # Clean up the copy to remove git and terraform files
        pushd ${ROOT_SRC_DIR}/${REPO_NAME}
        rm -rf .git .github .terraform
        popd

        # Perform the packing of the templates
        dotent pack -p:PackageVersion=${BUILD_BUILDNUMBER} -o output/packages
    env:
      ROOT_SRC_DIR: $(Agent.BuildDirectory)/s
      REPO_NAME: ${{ parameters.repo_name }}

  # Upload the packages as artifacts
  - task: PublishPipelineArtifact@1
    displayName: "Publish: NuGet Packages"
    inputs:
      path: ${{ parameters.root_src_dir }}/output/packages
      artifact: packages
